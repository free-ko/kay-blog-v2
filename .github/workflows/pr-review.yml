name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # íŠ¹ì • ê²½ë¡œë§Œ ê²€ì‚¬í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    # paths:
    #   - "src/**"
    #   - "app/**"
    #   - "components/**"

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # Claude APIë¥¼ ì‚¬ìš©í•œ AI ê¸°ë°˜ ì½”ë“œ ë¦¬ë·°
  claude-review:
    if: github.event.pull_request.draft == false  # Draft PRì€ ì œì™¸
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: AI Code Review with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Progress tracking í™œì„±í™”
          track_progress: true

          # ì»¤ìŠ¤í…€ ë¦¬ë·° ì§€ì‹œì‚¬í•­
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ì´ PRì˜ ë³€ê²½ì‚¬í•­ì„ ì² ì €íˆ ë¶„ì„í•˜ê³  ë‹¤ìŒ ê´€ì ì—ì„œ ìƒì„¸í•œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:

            ## ë¦¬ë·° ê¸°ì¤€

            1. **ì½”ë“œ í’ˆì§ˆ**
               - ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±
               - ì½”ë“œ ë³µì¡ë„ì™€ êµ¬ì¡°
               - ë„¤ì´ë° ì»¨ë²¤ì…˜ ì¤€ìˆ˜

            2. **ì ì¬ì  ë²„ê·¸ ë° ì•ˆì •ì„±**
               - ì—£ì§€ ì¼€ì´ìŠ¤ ì²˜ë¦¬
               - TypeScript íƒ€ì… ì•ˆì •ì„±
               - ì—ëŸ¬ ì²˜ë¦¬ ë° ì˜ˆì™¸ ìƒí™© ëŒ€ì‘

            3. **ì„±ëŠ¥ ìµœì í™”**
               - React ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ ìµœì í™”
               - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±
               - ë¶ˆí•„ìš”í•œ ê³„ì‚°ì´ë‚˜ ë¦¬ë Œë”ë§

            4. **ë³´ì•ˆ ì·¨ì•½ì **
               - XSS, CSRF ë“± ì›¹ ë³´ì•ˆ ì´ìŠˆ
               - ë¯¼ê° ì •ë³´ ë…¸ì¶œ
               - ì˜ì¡´ì„± ë³´ì•ˆ ë¬¸ì œ

            5. **ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤**
               - React/Next.js ìµœì‹  íŒ¨í„´ í™œìš©
               - TypeScript ê³ ê¸‰ ê¸°ëŠ¥ í™œìš©
               - ì½”ë“œ ì¬ì‚¬ìš©ì„±

            ## ë¦¬ë·° ë°©ë²•
            - ê° ì´ìŠˆì— ëŒ€í•´ êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸ë¥¼ ëª…ì‹œ
            - ê°œì„  ë°©ì•ˆì„ ì½”ë“œ ì˜ˆì œì™€ í•¨ê»˜ ì œì‹œ
            - ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ í†µí•´ êµ¬ì²´ì ì¸ í”¼ë“œë°± ì œê³µ
            - ì‹¬ê°ë„ì— ë”°ë¼ ì´ìŠˆë¥¼ ë¶„ë¥˜ (Critical/Warning/Info)

          # Claude ë„êµ¬ ê¶Œí•œ ì„¤ì •
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

  # íŒ¨í„´ ê¸°ë°˜ ìë™ ì½”ë“œ ë¦¬ë·°
  pattern-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Analyze and Review PR
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const pr = context.payload.pull_request;

          // PRì˜ ë³€ê²½ëœ íŒŒì¼ê³¼ diff ê°€ì ¸ì˜¤ê¸°
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number
          });

          const comments = [];
          const summary = {
            totalFiles: files.length,
            additions: 0,
            deletions: 0,
            issues: {
              critical: [],
              warning: [],
              info: []
            }
          };

          // ê° íŒŒì¼ ë¶„ì„
          for (const file of files) {
            summary.additions += file.additions;
            summary.deletions += file.deletions;

            if (!file.patch) continue;

            const fileExtension = file.filename.split('.').pop();
            const lines = file.patch.split('\n');
            let lineNumber = 0;
            let inHunk = false;
            let hunkStartLine = 0;

            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];

              // ìƒˆë¡œìš´ hunk ì‹œì‘
              if (line.startsWith('@@')) {
                const match = line.match(/@@ -\d+(?:,\d+)? \+(\d+)/);
                if (match) {
                  hunkStartLine = parseInt(match[1]);
                  lineNumber = hunkStartLine - 1;
                  inHunk = true;
                }
                continue;
              }

              if (!inHunk) continue;

              // ì¶”ê°€ëœ ë¼ì¸ë§Œ ê²€ì‚¬
              if (line.startsWith('+')) {
                lineNumber++;
                const codeContent = line.substring(1);

                // JavaScript/TypeScript íŒŒì¼ ê²€ì‚¬
                if (['js', 'jsx', 'ts', 'tsx'].includes(fileExtension)) {

                  // 1. console ë¬¸ ê²€ì‚¬
                  if (codeContent.match(/console\.(log|warn|error|debug)/)) {
                    const severity = codeContent.includes('console.error') ? 'info' : 'warning';
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `âš ï¸ **Console ë¬¸ ë°œê²¬**: í”„ë¡œë•ì…˜ ì½”ë“œì—ì„œëŠ” ì œê±°í•˜ê±°ë‚˜ ì ì ˆí•œ ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`
                    });
                    summary.issues[severity].push(`consoleë¬¸ ì‚¬ìš©: ${file.filename}:${lineNumber}`);
                  }

                  // 2. any íƒ€ì… ì‚¬ìš© (TypeScript)
                  if (['ts', 'tsx'].includes(fileExtension)) {
                    if (codeContent.match(/:\s*any(?:\s|\[|\)|,|;|$)/)) {
                      comments.push({
                        path: file.filename,
                        line: lineNumber,
                        side: 'RIGHT',
                        body: `ğŸš¨ **any íƒ€ì… ì‚¬ìš©**: íƒ€ì… ì•ˆì •ì„±ì„ ìœ„í•´ êµ¬ì²´ì ì¸ íƒ€ì…ì„ ì •ì˜í•´ì£¼ì„¸ìš”.\n\nì˜ˆì‹œ:\n\`\`\`typescript\n// Bad\nconst data: any = response;\n\n// Good\ninterface ResponseData {\n  id: string;\n  // ... í•„ìš”í•œ ì†ì„± ì •ì˜\n}\nconst data: ResponseData = response;\n\`\`\``
                      });
                      summary.issues.critical.push(`any íƒ€ì…: ${file.filename}:${lineNumber}`);
                    }
                  }

                  // 3. ë¹„ë™ê¸° ì²˜ë¦¬ íŒ¨í„´
                  if (codeContent.includes('.then(') && !codeContent.includes('.catch(')) {
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `âš ï¸ **ì—ëŸ¬ ì²˜ë¦¬ ëˆ„ë½**: Promise chainì— .catch() ë˜ëŠ” try-catchë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.`
                    });
                    summary.issues.warning.push(`ì—ëŸ¬ ì²˜ë¦¬ ëˆ„ë½: ${file.filename}:${lineNumber}`);
                  }

                  // 4. React ê´€ë ¨ íŒ¨í„´ (tsx íŒŒì¼)
                  if (fileExtension === 'tsx') {
                    // useEffect ì˜ì¡´ì„± ë°°ì—´ ê²€ì‚¬
                    if (codeContent.includes('useEffect(') && codeContent.includes('[]')) {
                      comments.push({
                        path: file.filename,
                        line: lineNumber,
                        side: 'RIGHT',
                        body: `ğŸ’¡ **useEffect ì˜ì¡´ì„±**: ë¹ˆ ì˜ì¡´ì„± ë°°ì—´ì´ ì˜ë„ì ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. ESLintì˜ exhaustive-deps ê·œì¹™ í™œìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
                      });
                      summary.issues.info.push(`useEffect ë¹ˆ ì˜ì¡´ì„±: ${file.filename}:${lineNumber}`);
                    }

                    // ì¸ë¼ì¸ í•¨ìˆ˜ ì •ì˜
                    if (codeContent.match(/onClick=\{\s*\(/) || codeContent.match(/onChange=\{\s*\(/)) {
                      comments.push({
                        path: file.filename,
                        line: lineNumber,
                        side: 'RIGHT',
                        body: `ğŸ’¡ **ì„±ëŠ¥ ìµœì í™”**: ì¸ë¼ì¸ í•¨ìˆ˜ëŠ” ë§¤ ë Œë”ë§ë§ˆë‹¤ ì¬ìƒì„±ë©ë‹ˆë‹¤. useCallbackì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ì— ì •ì˜í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ì£¼ì„¸ìš”.`
                      });
                      summary.issues.info.push(`ì¸ë¼ì¸ í•¨ìˆ˜: ${file.filename}:${lineNumber}`);
                    }
                  }

                  // 5. ë³´ì•ˆ ê´€ë ¨
                  if (codeContent.match(/dangerouslySetInnerHTML/)) {
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `ğŸ”’ **ë³´ì•ˆ ì£¼ì˜**: dangerouslySetInnerHTML ì‚¬ìš© ì‹œ XSS ê³µê²©ì— ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. DOMPurify ë“±ì˜ sanitization ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
                    });
                    summary.issues.critical.push(`XSS ìœ„í—˜: ${file.filename}:${lineNumber}`);
                  }

                  // 6. í•˜ë“œì½”ë”©ëœ ê°’
                  if (codeContent.match(/['"]https?:\/\/localhost/)) {
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `âš ï¸ **í•˜ë“œì½”ë”©ëœ URL**: í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš” (ì˜ˆ: process.env.NEXT_PUBLIC_API_URL)`
                    });
                    summary.issues.warning.push(`í•˜ë“œì½”ë”©ëœ localhost: ${file.filename}:${lineNumber}`);
                  }
                }

                // CSS/SCSS íŒŒì¼ ê²€ì‚¬
                if (['css', 'scss', 'module.css', 'module.scss'].includes(fileExtension)) {
                  // !important ì‚¬ìš©
                  if (codeContent.includes('!important')) {
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `ğŸ’¡ **CSS ìš°ì„ ìˆœìœ„**: !important ëŒ€ì‹  ë” êµ¬ì²´ì ì¸ ì„ íƒìë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ CSS êµ¬ì¡°ë¥¼ ê°œì„ í•´ì£¼ì„¸ìš”.`
                    });
                    summary.issues.info.push(`!important ì‚¬ìš©: ${file.filename}:${lineNumber}`);
                  }
                }

                // ëª¨ë“  íŒŒì¼ ê³µí†µ
                // API í‚¤ë‚˜ ì‹œí¬ë¦¿ ê²€ì‚¬
                if (codeContent.match(/(?:api[_-]?key|secret|password|token)\s*[:=]\s*['"][^'"]+['"]/i)) {
                  if (!codeContent.includes('process.env') && !codeContent.includes('import.meta.env')) {
                    comments.push({
                      path: file.filename,
                      line: lineNumber,
                      side: 'RIGHT',
                      body: `ğŸš¨ **ë³´ì•ˆ ê²½ê³ **: ë¯¼ê°í•œ ì •ë³´ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”!`
                    });
                    summary.issues.critical.push(`ë¯¼ê°ì •ë³´ ë…¸ì¶œ ìœ„í—˜: ${file.filename}:${lineNumber}`);
                  }
                }
              } else if (line.startsWith('-')) {
                // ì‚­ì œëœ ë¼ì¸ì€ ë¬´ì‹œ
              } else {
                // ë³€ê²½ë˜ì§€ ì•Šì€ ë¼ì¸
                lineNumber++;
              }
            }
          }

          // ë¦¬ë·° ê²°ê³¼ ìƒì„±
          let reviewBody = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n`;
          reviewBody += `### ğŸ“Š ë³€ê²½ ìš”ì•½\n`;
          reviewBody += `- ğŸ“ ë³€ê²½ëœ íŒŒì¼: ${summary.totalFiles}ê°œ\n`;
          reviewBody += `- â• ì¶”ê°€ëœ ë¼ì¸: ${summary.additions}\n`;
          reviewBody += `- â– ì‚­ì œëœ ë¼ì¸: ${summary.deletions}\n\n`;

          if (summary.issues.critical.length > 0 ||
              summary.issues.warning.length > 0 ||
              summary.issues.info.length > 0) {

            reviewBody += `### ğŸ” ë°œê²¬ëœ ì´ìŠˆ\n\n`;

            if (summary.issues.critical.length > 0) {
              reviewBody += `#### ğŸš¨ Critical (${summary.issues.critical.length})\n`;
              summary.issues.critical.forEach(issue => {
                reviewBody += `- ${issue}\n`;
              });
              reviewBody += `\n`;
            }

            if (summary.issues.warning.length > 0) {
              reviewBody += `#### âš ï¸ Warning (${summary.issues.warning.length})\n`;
              summary.issues.warning.forEach(issue => {
                reviewBody += `- ${issue}\n`;
              });
              reviewBody += `\n`;
            }

            if (summary.issues.info.length > 0) {
              reviewBody += `#### ğŸ’¡ Info (${summary.issues.info.length})\n`;
              summary.issues.info.forEach(issue => {
                reviewBody += `- ${issue}\n`;
              });
              reviewBody += `\n`;
            }

            reviewBody += `### ğŸ’¬ ìƒì„¸ ë¦¬ë·°\n`;
            reviewBody += `ê° íŒŒì¼ì˜ êµ¬ì²´ì ì¸ ì½”ë©˜íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\n\n`;

            // ê°œì„  ì œì•ˆ
            reviewBody += `### ğŸ“ ê°œì„  ì œì•ˆ\n`;
            if (summary.issues.critical.length > 0) {
              reviewBody += `- **ë³´ì•ˆ ë° íƒ€ì… ì•ˆì •ì„±**: Critical ì´ìŠˆë¥¼ ìš°ì„ ì ìœ¼ë¡œ í•´ê²°í•´ì£¼ì„¸ìš”\n`;
            }
            if (comments.some(c => c.body.includes('useCallback'))) {
              reviewBody += `- **ì„±ëŠ¥ ìµœì í™”**: React ë Œë”ë§ ìµœì í™”ë¥¼ ìœ„í•´ ë©”ëª¨ì´ì œì´ì…˜ì„ ê³ ë ¤í•´ì£¼ì„¸ìš”\n`;
            }
            if (comments.some(c => c.body.includes('console'))) {
              reviewBody += `- **ë¡œê¹…**: í”„ë¡œë•ì…˜ í™˜ê²½ì„ ìœ„í•œ ì ì ˆí•œ ë¡œê¹… ì „ëµì„ ìˆ˜ë¦½í•´ì£¼ì„¸ìš”\n`;
            }
          } else {
            reviewBody += `### âœ… í›Œë¥­í•©ë‹ˆë‹¤!\n\n`;
            reviewBody += `ìë™ ê²€ì‚¬ ê²°ê³¼ íŠ¹ë³„í•œ ì´ìŠˆë¥¼ ë°œê²¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n`;
            reviewBody += `ê²€ì‚¬ í•­ëª©:\n`;
            reviewBody += `- âœ“ Console ë¬¸ ì‚¬ìš©\n`;
            reviewBody += `- âœ“ TypeScript any íƒ€ì…\n`;
            reviewBody += `- âœ“ ì—ëŸ¬ ì²˜ë¦¬\n`;
            reviewBody += `- âœ“ React ìµœì í™” íŒ¨í„´\n`;
            reviewBody += `- âœ“ ë³´ì•ˆ ì·¨ì•½ì \n`;
            reviewBody += `- âœ“ í•˜ë“œì½”ë”©ëœ ê°’\n`;
          }

          // PR ë¦¬ë·° ìƒì„±
          if (comments.length > 0) {
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'COMMENT',
              body: reviewBody,
              comments: comments
            });
          } else {
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'COMMENT',
              body: reviewBody
            });
          }

          console.log(`âœ… ë¦¬ë·° ì™„ë£Œ: ${comments.length}ê°œì˜ ì½”ë©˜íŠ¸ ìƒì„±`);