name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41

    - name: Review PR
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const pr = context.payload.pull_request;
          const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');

          // PRì— ëŒ€í•œ ì „ì²´ ë¦¬ë·° ì½”ë©˜íŠ¸
          const reviewComment = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number,
            body: `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°

            PR #${pr.number}ì— ëŒ€í•œ ìë™ ë¦¬ë·°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.

            ### ğŸ“ ë³€ê²½ëœ íŒŒì¼
            ${changedFiles.map(f => `- \`${f}\``).join('\n')}

            ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì½”ë“œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜
            - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ í¬í•¨ ì—¬ë¶€
            - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€
            - [ ] ì„±ëŠ¥ ì˜í–¥ ê²€í† `,
            event: 'COMMENT'
          };

          await github.rest.pulls.createReview(reviewComment);

          // íŠ¹ì • íŒŒì¼ì— ëŒ€í•œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ (ì˜ˆì‹œ)
          if (changedFiles.some(f => f.includes('particles.tsx'))) {
            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const particlesFile = prFiles.find(f => f.filename.includes('particles.tsx'));

            if (particlesFile && particlesFile.patch) {
              // íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì—ì„œ íŠ¹ì • íŒ¨í„´ ì°¾ê¸°
              const lines = particlesFile.patch.split('\n');
              let position = 0;

              for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                position++;

                // type Circle ì •ì˜ë¥¼ ì°¾ì•˜ì„ ë•Œ ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
                if (line.includes('+type Circle')) {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    body: 'ğŸ‘ íƒ€ì… ì •ì˜ë¥¼ ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ë¡œ ì´ë™í•œ ê²ƒì€ ì¢‹ì€ ì„ íƒì…ë‹ˆë‹¤. ì¬ì‚¬ìš©ì„±ê³¼ ê°€ë…ì„±ì´ í–¥ìƒë˜ì—ˆë„¤ìš”!',
                    path: particlesFile.filename,
                    position: position,
                    commit_id: pr.head.sha
                  });
                }

                // useCallback ì‚¬ìš© íŒ¨í„´ ë°œê²¬ ì‹œ
                if (line.includes('+') && line.includes('useCallback')) {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    body: 'âœ¨ useCallbackì„ ì‚¬ìš©í•œ ì„±ëŠ¥ ìµœì í™”ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                    path: particlesFile.filename,
                    position: position,
                    commit_id: pr.head.sha
                  });
                }
              }
            }
          }

          // TypeScript íŒŒì¼ ë³€ê²½ ì‹œ íƒ€ì… ì²´í¬ ê´€ë ¨ ì½”ë©˜íŠ¸
          const tsFiles = changedFiles.filter(f => f.endsWith('.ts') || f.endsWith('.tsx'));
          if (tsFiles.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `### ğŸ” TypeScript íŒŒì¼ ê²€í† 

              ë‹¤ìŒ TypeScript íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:
              ${tsFiles.map(f => `- \`${f}\``).join('\n')}

              íƒ€ì… ì•ˆì •ì„±ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`
            });
          }