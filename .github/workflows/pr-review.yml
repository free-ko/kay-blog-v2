name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41

    - name: Review PR
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const pr = context.payload.pull_request;
          const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');

          // PR에 대한 전체 리뷰 코멘트
          const reviewComment = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number,
            body: `## 🤖 자동 코드 리뷰

            PR #${pr.number}에 대한 자동 리뷰가 시작되었습니다.

            ### 📝 변경된 파일
            ${changedFiles.map(f => `- \`${f}\``).join('\n')}

            ### ✅ 체크리스트
            - [ ] 코드 스타일 가이드라인 준수
            - [ ] 테스트 코드 포함 여부
            - [ ] 문서 업데이트 필요 여부
            - [ ] 성능 영향 검토`,
            event: 'COMMENT'
          };

          await github.rest.pulls.createReview(reviewComment);

          // 특정 파일에 대한 인라인 코멘트 (예시)
          if (changedFiles.some(f => f.includes('particles.tsx'))) {
            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const particlesFile = prFiles.find(f => f.filename.includes('particles.tsx'));

            if (particlesFile && particlesFile.patch) {
              // 파일의 변경사항에서 특정 패턴 찾기
              const lines = particlesFile.patch.split('\n');
              let position = 0;

              for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                position++;

                // type Circle 정의를 찾았을 때 코멘트 남기기
                if (line.includes('+type Circle')) {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    body: '👍 타입 정의를 컴포넌트 외부로 이동한 것은 좋은 선택입니다. 재사용성과 가독성이 향상되었네요!',
                    path: particlesFile.filename,
                    position: position,
                    commit_id: pr.head.sha
                  });
                }

                // useCallback 사용 패턴 발견 시
                if (line.includes('+') && line.includes('useCallback')) {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    body: '✨ useCallback을 사용한 성능 최적화가 적용되었습니다. 불필요한 리렌더링을 방지할 수 있습니다.',
                    path: particlesFile.filename,
                    position: position,
                    commit_id: pr.head.sha
                  });
                }
              }
            }
          }

          // TypeScript 파일 변경 시 타입 체크 관련 코멘트
          const tsFiles = changedFiles.filter(f => f.endsWith('.ts') || f.endsWith('.tsx'));
          if (tsFiles.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `### 🔍 TypeScript 파일 검토

              다음 TypeScript 파일들이 변경되었습니다:
              ${tsFiles.map(f => `- \`${f}\``).join('\n')}

              타입 안정성을 확인해주세요.`
            });
          }